<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            scroll-behavior: smooth;
        }
        
        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }
        
                 .header {
             background: linear-gradient(135deg, #ea4335 0%, #fbbc04 100%);
             color: white;
             padding: 15px;
             text-align: center;
             position: relative;
         }
        
        .home-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 0.9rem;
        }
        
        .home-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
                 .header h1 {
             font-size: 1.5rem;
             margin-bottom: 3px;
             font-weight: 300;
         }
         
         .header p {
             font-size: 0.8rem;
             opacity: 0.9;
         }
        
        .content {
            padding: 20px 15px;
        }
        
        .stats-bar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ea4335;
        }
        
        .sort-controls {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .sort-controls label {
            font-weight: 500;
            color: #1976d2;
            font-size: 0.9rem;
        }
        

        
        .random-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .random-btn:hover {
            background: linear-gradient(135deg, #ee5a24 0%, #d63031 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(238, 90, 36, 0.3);
        }
        
        .random-btn:active {
            transform: translateY(0);
        }
        
        .difficult-questions {
            display: grid;
            gap: 12px;
        }
        
        .question-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .question-card:hover {
            border-color: #ea4335;
            box-shadow: 0 4px 12px rgba(234, 67, 53, 0.1);
            transform: translateY(-1px);
        }
        
                 .question-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 8px;
             gap: 8px;
         }
        
                 .question-number {
             background: #ea4335;
             color: white;
             padding: 6px 12px;
             border-radius: 15px;
             font-weight: bold;
             font-size: 12px;
         }
        
                 .question-source {
             background: #4285f4;
             color: white;
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 11px;
             font-weight: 500;
         }
        
        .question-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 10px;
        }
        
                               
        
        .answer-item {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .answer-item:last-child {
            border-bottom: none;
        }
        
        .answer-label {
            font-weight: bold;
            color: #4285f4;
            margin-right: 8px;
        }
        
        .question-timestamp {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        
        .remove-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 40px;
            flex-shrink: 0;
        }
        
        .remove-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }
        
                 /* Quiz functionality styles */
                       .quiz-mode {
                  background: #e3f2fd;
                  border: 2px solid #2196f3;
                  border-radius: 8px;
                  padding: 15px 10px;
                  margin: 0 -10px 15px -10px;
              }
        
        .quiz-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .quiz-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.2);
        }
        
        .quiz-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }
        
        .quiz-btn:focus {
            outline: 2px solid #2196f3;
            outline-offset: 2px;
        }
        
        .quiz-btn.active {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        }
        
                 .answer-option {
             display: flex;
             align-items: center;
             padding: 12px 15px;
             margin: 8px -15px;
             background: white;
             border: 2px solid #e0e0e0;
             border-radius: 8px;
             cursor: pointer;
             transition: all 0.3s ease;
             box-shadow: 0 1px 3px rgba(0,0,0,0.1);
         }
        
        .answer-option:hover {
            border-color: #2196f3;
            background: #f5f5f5;
            transform: translateX(2px);
        }
        
        .answer-option:focus-within {
            outline: 2px solid #2196f3;
            outline-offset: 2px;
        }
        
        .answer-option.selected {
            border-color: #2196f3;
            background: #e3f2fd;
        }
        
        .answer-option.correct {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        
        .answer-option.incorrect {
            border-color: #f44336;
            background: #ffebee;
        }
        
        .answer-radio {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .answer-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .feedback {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .feedback.correct {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .feedback.incorrect {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
                                   .quiz-stats {
              background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
              border: 1px solid #dee2e6;
              border-radius: 8px;
              padding: 8px 12px;
              margin-bottom: 15px;
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: nowrap;
              gap: 10px;
          }
        
                 .quiz-stats-number {
             font-size: 1.2rem;
             font-weight: bold;
             color: #2196f3;
         }
        
        /* Tab styles */
        .tab-container {
            margin-bottom: 30px;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.9rem;
        }
        
        .tab-btn.active {
            background: white;
            color: #2196f3;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }
        
        .tab-btn:hover:not(.active) {
            background: rgba(33, 150, 243, 0.1);
            color: #2196f3;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #333;
        }
        
        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .back-btn {
            display: inline-block;
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(66, 133, 244, 0.4);
        }
        
        .footer {
            background: #333;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
        }
        
                 @media (max-width: 768px) {
                           .header {
                  padding: 12px;
              }
              
              .header h1 {
                  font-size: 1.3rem;
                  margin-bottom: 2px;
              }
              
              .header p {
                  font-size: 0.75rem;
              }
             
             .content {
                 padding: 10px 5px;
             }
             
                           .question-header {
                  flex-direction: row;
                  gap: 6px;
                  align-items: center;
                  flex-wrap: wrap;
                  margin-bottom: 6px;
              }
             
             .home-btn {
                 top: 8px;
                 left: 8px;
                 padding: 6px 12px;
                 font-size: 0.8rem;
             }
             
             .quiz-controls {
                 flex-direction: row;
                 align-items: center;
                 justify-content: center;
                 gap: 10px;
             }
             
             .quiz-btn {
                 width: auto;
                 min-width: 120px;
                 margin-bottom: 0;
                 font-size: 0.9rem;
                 padding: 8px 16px;
             }
             
                           .answer-option {
                  padding: 10px 12px;
                  margin: 8px -12px;
              }
             
             .tab-buttons {
                 display: flex;
                 flex-direction: row;
                 gap: 5px;
             }
             
             .tab-btn {
                 margin-bottom: 0;
                 padding: 10px 8px;
                 font-size: 0.8rem;
                 min-width: 0;
             }
             
             .remove-btn {
                 padding: 6px 12px;
                 font-size: 0.8rem;
                 align-self: flex-end;
             }
             
                           .stats-bar {
                  padding: 10px;
                  margin-bottom: 15px;
              }
              
              .stats-number {
                  font-size: 1.5rem;
              }
              
              .quiz-stats {
                  padding: 6px 10px;
                  margin-bottom: 10px;
                  font-size: 0.8rem;
              }
              
                           .quiz-stats-number {
                 font-size: 1rem;
             }
             
             .sort-controls {
                 flex-direction: column;
                 align-items: stretch;
                 gap: 8px;
             }
             
             .sort-controls > div {
                 flex-direction: column;
                 gap: 8px;
             }
             
             .sort-controls label {
                 text-align: center;
             }
             
             .sort-select {
                 width: 100%;
                 text-align: center;
             }
             
             #sourceStats {
                 margin-left: 0 !important;
                 margin-top: 8px;
                 text-align: center;
             }
         }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="home-btn">🏠 Trang chủ</a>
            <h1>🔥 Câu Hỏi Khó</h1>
            <p>Danh sách các câu hỏi bạn là khó để ôn tập</p>
        </div>
        
        <div class="content">
            <!-- Tab Container -->
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('list')">
                        📋 Danh sách câu khó
                    </button>
                    <button class="tab-btn" onclick="switchTab('quiz')">
                        🎯 Chế độ Quiz
                    </button>
                </div>
                
                <!-- Tab 1: Danh sách câu khó -->
                <div class="tab-content active" id="listTab">
                    <div class="stats-bar">
                        <div class="stats-number" id="totalDifficult">0</div>
                        <div>câu hỏi khó</div>
                        <button onclick="clearAllDifficultQuestions()" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px;">
                            🗑️ Xóa tất cả (Debug)
                        </button>
                        <button onclick="clearCacheAndReload()" style="margin-top: 10px; background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px;">
                            🔄 Clear Cache & Reload
                        </button>
                        
                    </div>
                    
                                         <div class="sort-controls">
                         <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                             <div>
                                 <label for="filterSelect">Lọc theo:</label>
                                 <select id="filterSelect" class="sort-select" onchange="filterDifficultQuestions()">
                                     <option value="all">Tất cả phần thi</option>
                                     <option value="1-50">Part 1 (Questions 1-50)</option>
                                     <option value="51-100">Part 2 (Questions 51-100)</option>
                                     <option value="101-150">Part 3 (Questions 101-150)</option>
                                     <option value="151-200">Part 4 (Questions 151-200)</option>
                                     <option value="201-250">Part 5 (Questions 201-250)</option>
                                     <option value="251-302">Part 6 (Questions 251-302)</option>
                                 </select>
                                                         </div>
                            <div>
                                <button onclick="randomizeQuestions()" class="random-btn">🎲 Ngẫu nhiên</button>
                            </div>
                         </div>
                         <div id="sourceStats" style="font-size: 0.8rem; color: #666; margin-left: auto;">
                             <!-- Source statistics will be shown here -->
                         </div>
                     </div>

                    <div class="difficult-questions" id="difficultQuestionsList">
                        <!-- Questions will be loaded here -->
                    </div>
                    
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <h3>📚 Chưa có câu hỏi khó nào</h3>
                        <p>Bạn chưa đánh dấu câu hỏi nào là khó. Hãy bắt đầu làm quiz và đánh dấu những câu hỏi bạn gặp khó khăn!</p>
                        <a href="index.html" class="back-btn">🏠 Về trang chủ</a>
                    </div>
                </div>
                
                <!-- Tab 2: Chế độ Quiz -->
                <div class="tab-content" id="quizTab">
                    <div class="quiz-mode">
                        <div class="quiz-controls">
                            <button class="quiz-btn" onclick="startQuiz()">▶️ Bắt đầu Quiz</button>
                            <button class="quiz-btn" onclick="nextQuestion()" id="nextBtn" style="display: none;">⏭️ Câu tiếp theo</button>
                            <button class="quiz-btn" onclick="showAnswer()" id="showAnswerBtn" style="display: none;">👁️ Xem đáp án</button>
                            <button class="quiz-btn" onclick="resetQuiz()" id="resetBtn" style="display: none;">🔄 Làm lại</button>
                        </div>
                        
                                                         <div class="quiz-stats" id="quizStats" style="display: none;">
                             <div style="font-size: 0.9rem; flex: 1; text-align: left;">Đã trả lời: <span class="quiz-stats-number" id="answeredCount">0</span>/<span class="quiz-stats-number" id="totalCount">0</span></div>
                             <div style="font-size: 0.9rem; flex: 1; text-align: right;">Đúng: <span class="quiz-stats-number" id="correctCount" style="color: #4caf50;">0</span> | Sai: <span class="quiz-stats-number" id="incorrectCount" style="color: #f44336;">0</span> | Xem: <span class="quiz-stats-number" id="viewedCount" style="color: #ff9800;">0</span></div>
                         </div>
                        
                        <div id="currentQuestion" style="display: none;">
                            <!-- Current question will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
        
        <div class="footer">
            <p>© 2024 GCP Exam Practice - Học tập hiệu quả, thành công trong kỳ thi!</p>
        </div>
    </div>

    <script>
        // Quiz state variables
        let quizData = null;
        let currentQuestionIndex = 0;
        let quizQuestions = [];
        let userAnswers = {};
        let quizStats = {
            answered: 0,
            correct: 0,
            incorrect: 0,
            viewed: 0  // Thêm trạng thái xem đáp án
        };
        
        // Quiz data fallback (embedded directly to avoid CORS issues)
        const FALLBACK_QUIZ_DATA = {
            "quizParts": {
                "part1": {
                    "name": "GCP Fundamentals",
                    "startNumber": 1,
                    "endNumber": 50,
                    "total": 50,
                    "correctAnswers": ["C", "B", "A", "C", "D", "D", "D", "A", "D", "A", "A", "C", "D", "B", "B", "B", "D", "B", "A", "D", "A", "D", "D", "A", "A", "C", "B", "B", "A", "B", "A", "C", "A", "C", "B", "C", "D", "B", "B", "A", "B", "B", "D", "C", "C", "D", "A", "C", "D", "A"]
                },
                "part2": {
                    "name": "Compute Engine & Networking",
                    "startNumber": 51,
                    "endNumber": 100,
                    "total": 50,
                    "correctAnswers": ["A", "C", "B", "A", "A", "B", "B", "B", "C", "C", "B", "A", "D", "C", "A", "A", "A", "C", "A", "B", "A", "C", "B", "A", "A", "D", "A", "A", "B", "C", "D", "A", "B", "A", "C", "A", "C", "A", "A", "B", "D", "D", "A", "B", "D", "B", "C", "C", "C", "D"]
                },
                "part3": {
                    "name": "Storage & Databases",
                    "startNumber": 101,
                    "endNumber": 150,
                    "total": 50,
                    "correctAnswers": ["D", "D", "C", "C", "B", "D", "A", "D", "A", "A", "C", "B", "B", "B", "A", "D", "C", "B", "B", "A", "A", "B", "B", "D", "C", "A", "C", "C", "A", "B", "D", "D", "B", "A", "A", "C", "A", "A", "D", "D", "A", "A", "B", "B", "B", "D", "A", "D", "D", "A"]
                },
                                "part4": {
                    "name": "Security & Identity",
                    "startNumber": 151,
                    "endNumber": 200,
                    "total": 50,
                    "correctAnswers": ["A", "D", "B", "D", "D", "C", "B", "C", "A", "A", "B", "B", "B", "D", "D", "B", "D", "C", "A", "B", "A", "C", "C", "D", "D", "A", "B", "D", "A", "A", "C", "C", "C", "B", "A", "A", "C", "B", "A", "C", "B", "D", "B", "B", "C", "B", "A", "A", "B", "C"]
                },
                "part5": {
                    "name": "Monitoring & Analytics",
                    "startNumber": 201,
                    "endNumber": 250,
                    "total": 50,
                    "correctAnswers": ["D", "C", "A", "A", "C", "A", "B", "A", "A", "B", "A", "A", "A", "B", "D", "B", "C", "B", "B", "D", "B", "B", "B", "D", "A", "D", "D", "A", "D", "B", "D", "B", "D", "D", "A", "A", "B", "B", "C", "D", "A", "C", "D", "C", "A", "B", "D", "A", "B", "D"]
                },
                "part6": {
                    "name": "Advanced Topics",
                    "startNumber": 251,
                    "endNumber": 302,
                    "total": 52,
                    "correctAnswers": ["D", "D", "A", "C", "B", "C", "B", "D", "A", "A", "C", "D", "A", "D", "A", "B", "A", "D", "C", "B", "B", "D", "C", "D", "A", "B", "A", "A", "C", "B", "C", "B", "B", "C", "B", "D", "B", "A", "B", "A", "D", "C", "B", "B", "B", "C", "B", "C", "D", "A", "D", "D"]
                }
            }
        };

        // Load quiz data from quiz-data.json
        async function loadQuizData() {
            try {
                console.log('Attempting to load quiz data...');
                const response = await fetch('quiz-data.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                quizData = await response.json();
                console.log('Quiz data loaded successfully:', quizData);
                
                // Validate quiz data structure
                if (!quizData || !quizData.quizParts) {
                    throw new Error('Invalid quiz data structure');
                }
                
                return true;
            } catch (error) {
                console.error('Error loading quiz data:', error);
                console.log('Using fallback quiz data...');
                
                // Use fallback data
                quizData = FALLBACK_QUIZ_DATA;
                console.log('Fallback quiz data loaded:', quizData);
                
                return true;
            }
        }
        
        function getDifficultQuestions() {
            try {
                const stored = localStorage.getItem('difficultQuestions');
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error reading from localStorage:', error);
                return [];
            }
        }

        function removeDifficultQuestion(questionId) {
            try {
                const questions = getDifficultQuestions();
                const updatedQuestions = questions.filter(q => q.id !== questionId);
                localStorage.setItem('difficultQuestions', JSON.stringify(updatedQuestions));
                loadDifficultQuestions();
            } catch (error) {
                console.error('Error removing question:', error);
            }
        }
        
        // Function để xóa tất cả dữ liệu cũ (debug)
        function clearAllDifficultQuestions() {
            try {
                localStorage.removeItem('difficultQuestions');
                loadDifficultQuestions();
                console.log('Cleared all difficult questions');
            } catch (error) {
                console.error('Error clearing questions:', error);
            }
        }

        // Function để clear cache và reload data
        function clearCacheAndReload() {
            try {
                // Clear localStorage
                localStorage.removeItem('difficultQuestions');
                
                // Clear quiz data
                quizData = null;
                
                // Reload quiz data
                loadQuizData().then(() => {
                    loadDifficultQuestions();
                    console.log('Cache cleared and data reloaded');
                });
            } catch (error) {
                console.error('Error clearing cache:', error);
            }
        }



        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('vi-VN');
            } catch (error) {
                return 'Không xác định';
            }
        }

        function getSourceDisplayName(source) {
            const sourceNames = {
                'part1': 'GCP Fundamentals',
                'part2': 'Compute Engine & Networking',
                'part3': 'Storage & Databases',
                'part4': 'Security & Identity',
                'part5': 'Monitoring & Analytics',
                'part6': 'Advanced Topics'
            };
            return sourceNames[source] || source;
        }

        function getRangeDisplayName(range) {
            const rangeNames = {
                '1-50': 'Part 1 (Questions 1-50)',
                '51-100': 'Part 2 (Questions 51-100)',
                '101-150': 'Part 3 (Questions 101-150)',
                '151-200': 'Part 4 (Questions 151-200)',
                '201-250': 'Part 5 (Questions 201-250)',
                '251-302': 'Part 6 (Questions 251-302)'
            };
            return rangeNames[range] || range;
        }

        function updateSourceStats(questions) {
            const sourceStatsElement = document.getElementById('sourceStats');
            if (!sourceStatsElement) return;
            
            if (questions.length === 0) {
                sourceStatsElement.innerHTML = '';
                return;
            }
            
            // Count questions by range
            const rangeCounts = {};
            questions.forEach(question => {
                const questionNum = parseInt(question.questionNumber);
                let range = '';
                
                if (questionNum >= 1 && questionNum <= 50) {
                    range = 'Part 1 (1-50)';
                } else if (questionNum >= 51 && questionNum <= 100) {
                    range = 'Part 2 (51-100)';
                } else if (questionNum >= 101 && questionNum <= 150) {
                    range = 'Part 3 (101-150)';
                } else if (questionNum >= 151 && questionNum <= 200) {
                    range = 'Part 4 (151-200)';
                } else if (questionNum >= 201 && questionNum <= 250) {
                    range = 'Part 5 (201-250)';
                } else if (questionNum >= 251 && questionNum <= 302) {
                    range = 'Part 6 (251-302)';
                } else {
                    range = 'Unknown';
                }
                
                rangeCounts[range] = (rangeCounts[range] || 0) + 1;
            });
            
            // Create statistics display
            const statsHtml = Object.entries(rangeCounts)
                .map(([range, count]) => `${range}: ${count}`)
                .join(' | ');
            
            sourceStatsElement.innerHTML = statsHtml;
        }

        function loadDifficultQuestions() {
            const questions = getDifficultQuestions();
            const container = document.getElementById('difficultQuestionsList');
            const emptyState = document.getElementById('emptyState');
            const totalElement = document.getElementById('totalDifficult');
            
            // Apply filter
            const filterSelect = document.getElementById('filterSelect');
            const filterValue = filterSelect ? filterSelect.value : 'all';
            let filteredQuestions = questions;
            
            if (filterValue !== 'all') {
                // Parse the range (e.g., "1-50" -> start: 1, end: 50)
                const [start, end] = filterValue.split('-').map(num => parseInt(num));
                filteredQuestions = questions.filter(question => {
                    const questionNum = parseInt(question.questionNumber);
                    return questionNum >= start && questionNum <= end;
                });
            }
            
            totalElement.textContent = filteredQuestions.length;
            
            // Update source statistics with filtered questions
            updateSourceStats(filteredQuestions);
            
            if (filteredQuestions.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'grid';
            emptyState.style.display = 'none';
            
            container.innerHTML = filteredQuestions.map(question => {
                // Tạo HTML cho đáp án
                let answersHtml = '';
                if (question.answers && question.answers.length > 0) {
                    answersHtml = `
                                                 <div style="font-weight: bold; margin-bottom: 10px; color: #333;">📝 Các đáp án:</div>
                            ${question.answers.map((answer, index) => {
                                const labels = ['A', 'B', 'C', 'D'];
                                const label = labels[index] || (index + 1);
                                
                                // Đảm bảo answer không có label ở đầu
                                let cleanAnswer = answer;
                                const labelPattern = new RegExp(`^${label}\\.\\s*`);
                                if (labelPattern.test(cleanAnswer)) {
                                    cleanAnswer = cleanAnswer.replace(labelPattern, '');
                                }
                                
                                return `<div class="answer-item">
                                    <span class="answer-label">${label}.</span>
                                    ${cleanAnswer}
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                }
                
                return `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-number">Câu ${question.questionNumber}</div>
                            <div class="question-source">${getSourceDisplayName(question.source)}</div>
                        </div>
                        <div class="question-text">${question.text}</div>
                        ${answersHtml}
                        <div class="question-timestamp">
                            Đánh dấu lúc: ${formatTimestamp(question.timestamp)}
                        </div>
                        <button class="remove-btn" onclick="removeDifficultQuestion('${question.id}')">
                            🗑️ Xóa khỏi danh sách
                        </button>
                    </div>
                `;
            }).join('');
        }

        // Shuffle function for answers
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        

        
        // Quiz functions
        function startQuiz() {
            const difficultQuestions = getDifficultQuestions();
            if (difficultQuestions.length === 0) {
                showNotification('Không có câu hỏi khó nào để làm quiz!', 'error');
                return;
            }
            
            // Prepare quiz questions with full data
            quizQuestions = difficultQuestions.map(q => {
                const questionNumber = parseInt(q.questionNumber);
                
                // Find correct answer from quiz data
                let correctAnswer = null;
                
                // Try to find the correct part based on question number
                if (quizData && quizData.quizParts) {
                    for (const [partKey, partData] of Object.entries(quizData.quizParts)) {
                        if (questionNumber >= partData.startNumber && questionNumber <= partData.endNumber) {
                            const partIndex = questionNumber - partData.startNumber;
                                            if (partIndex >= 0 && partIndex < partData.correctAnswers.length) {
                    correctAnswer = partData.correctAnswers[partIndex];
                    console.log(`Found correct answer for question ${questionNumber}: ${correctAnswer} from part ${partKey} (index ${partIndex})`);
                    break;
                }
                        }
                    }
                }
                
                if (!correctAnswer) {
                    console.warn(`Could not find correct answer for question ${questionNumber} from source: ${q.source}`);
                }
                
                return {
                    ...q,
                    correctAnswer: correctAnswer
                };
            });
            
            // Reset quiz state
            currentQuestionIndex = 0;
            userAnswers = {};
            quizStats = {
                answered: 0,
                correct: 0,
                incorrect: 0,
                viewed: 0
            };
            
            // Show quiz elements
            const quizStatsElement = document.getElementById('quizStats');
            const nextBtnElement = document.getElementById('nextBtn');
            const showAnswerBtnElement = document.getElementById('showAnswerBtn');
            const resetBtnElement = document.getElementById('resetBtn');
            
                         if (quizStatsElement) quizStatsElement.style.display = 'flex';
            if (nextBtnElement) nextBtnElement.style.display = 'none';
            if (showAnswerBtnElement) showAnswerBtnElement.style.display = 'none';
            if (resetBtnElement) resetBtnElement.style.display = 'none';
            
            // Load first question
            loadCurrentQuestion();
            updateQuizStats();
        }
        
        function loadCurrentQuestion(forceShuffle = true) {
            if (currentQuestionIndex >= quizQuestions.length) {
                showQuizResults();
                return;
            }
            
            const question = quizQuestions[currentQuestionIndex];
            const questionDiv = document.getElementById('currentQuestion');
            
            if (!questionDiv) {
                console.error('Question div not found');
                return;
            }
            
            // Create answer options with shuffling support
            const labels = ['A', 'B', 'C', 'D'];
            let answerOptions = [];
            
            // Create answer objects with their original labels
            const answerObjects = question.answers.map((answer, index) => {
                const label = labels[index] || (index + 1);
                let cleanAnswer = answer;
                const labelPattern = new RegExp(`^${label}\\.\\s*`);
                if (labelPattern.test(cleanAnswer)) {
                    cleanAnswer = cleanAnswer.replace(labelPattern, '');
                }
                
                return {
                    label: label,
                    text: cleanAnswer,
                    originalLabel: label, // Store original label for correct answer tracking
                    isCorrect: question.correctAnswer && question.correctAnswer === label
                };
            });
            
            // Only shuffle answers if this is the first time loading this question (not answered yet)
            if (userAnswers[currentQuestionIndex] === undefined) {
                // First time loading - shuffle and store the order
                answerOptions = shuffleArray(answerObjects);
                question.shuffledAnswers = [...answerOptions]; // Store the shuffled order
            } else {
                // When showing feedback, use the stored shuffled order
                answerOptions = question.shuffledAnswers || answerObjects;
            }
            
            // Update isCorrect property after shuffling based on original labels
            answerOptions.forEach(answerObj => {
                answerObj.isCorrect = question.correctAnswer && answerObj.originalLabel === question.correctAnswer;
            });
            
            // Generate HTML for answer options
            const answerOptionsHtml = answerOptions.map((answerObj) => {
                const isSelected = userAnswers[currentQuestionIndex] === answerObj.label;
                const isAnswered = userAnswers[currentQuestionIndex] !== undefined;
                const isCorrect = answerObj.isCorrect;
                const isIncorrect = isAnswered && userAnswers[currentQuestionIndex] === answerObj.label && !isCorrect;
                
                let optionClass = 'answer-option';
                if (isSelected) optionClass += ' selected';
                if (isAnswered && isCorrect) optionClass += ' correct';
                if (isIncorrect) optionClass += ' incorrect';
                
                return `
                    <div class="${optionClass}" onclick="selectAnswer('${answerObj.label}')">
                        <input type="radio" class="answer-radio" name="answer" value="${answerObj.label}" 
                               ${isSelected ? 'checked' : ''} ${isAnswered ? 'disabled' : ''}>
                        <div class="answer-text">
                            <strong>${answerObj.label}.</strong> ${answerObj.text}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Create feedback
            let feedback = '';
            if (userAnswers[currentQuestionIndex] !== undefined) {
                if (question.correctAnswer) {
                    // Find the correct answer label in the shuffled answers
                    let correctAnswerLabel = question.correctAnswer;
                    if (question.shuffledAnswers) {
                        const correctAnswerObj = question.shuffledAnswers.find(obj => obj.originalLabel === question.correctAnswer);
                        if (correctAnswerObj) {
                            correctAnswerLabel = correctAnswerObj.label;
                        }
                    }
                    
                    const isCorrect = userAnswers[currentQuestionIndex] === correctAnswerLabel;
                    const feedbackClass = isCorrect ? 'correct' : 'incorrect';
                    const feedbackText = isCorrect ? '✅ Đúng rồi!' : `❌ Sai rồi! Đáp án đúng là: ${correctAnswerLabel}`;
                    feedback = `<div class="feedback ${feedbackClass}">${feedbackText}</div>`;
                } else {
                    feedback = `<div class="feedback incorrect">⚠️ Không thể xác định đáp án đúng cho câu hỏi này</div>`;
                }
            }
            
            questionDiv.innerHTML = `
                <div class="question-card">
                    <div class="question-header">
                        <div class="question-number">Câu ${question.questionNumber} (${currentQuestionIndex + 1}/${quizQuestions.length})</div>
                        <div class="question-source">${getSourceDisplayName(question.source)}</div>
                    </div>
                    <div class="question-text">${question.text}</div>
                                         ${answerOptionsHtml}
                    ${feedback}
                </div>
            `;
            
            questionDiv.style.display = 'block';
            
            // Show/hide buttons based on state
            const showAnswerBtnElement = document.getElementById('showAnswerBtn');
            const nextBtnElement = document.getElementById('nextBtn');
            const resetBtnElement = document.getElementById('resetBtn');
            
            if (userAnswers[currentQuestionIndex] !== undefined) {
                if (showAnswerBtnElement) showAnswerBtnElement.style.display = 'none';
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    if (nextBtnElement) nextBtnElement.style.display = 'inline-block';
                } else {
                    if (resetBtnElement) resetBtnElement.style.display = 'inline-block';
                }
            } else {
                if (showAnswerBtnElement) showAnswerBtnElement.style.display = 'inline-block';
                if (nextBtnElement) nextBtnElement.style.display = 'none';
                if (resetBtnElement) resetBtnElement.style.display = 'none';
            }
        }
        
        function selectAnswer(answer) {
            if (userAnswers[currentQuestionIndex] !== undefined) return; // Already answered
            
            userAnswers[currentQuestionIndex] = answer;
            const question = quizQuestions[currentQuestionIndex];
            
            // Find the correct answer label in the shuffled answers
            let isCorrect = false;
            if (question.shuffledAnswers) {
                // Find the answer object that has the correct original label
                const correctAnswerObj = question.shuffledAnswers.find(obj => obj.originalLabel === question.correctAnswer);
                if (correctAnswerObj) {
                    isCorrect = answer === correctAnswerObj.label;
                }
            } else {
                // Fallback to original logic if no shuffling
                isCorrect = question.correctAnswer && answer === question.correctAnswer;
            }
            
            // Debug: Log để kiểm tra
            console.log('Selected answer:', answer);
            console.log('Correct answer:', question.correctAnswer);
            console.log('Is correct:', isCorrect);
            console.log('Question:', question);
            console.log('Shuffled answers:', question.shuffledAnswers);
            
            // Thêm debug chi tiết cho câu 189 và 190
            if (question.questionNumber === '189' || question.questionNumber === '190') {
                console.log(`=== DEBUG FOR QUESTION ${question.questionNumber} ===`);
                console.log('Question number:', question.questionNumber);
                console.log('Correct answer from database:', question.correctAnswer);
                console.log('User selected:', answer);
                console.log('Shuffled answers:', question.shuffledAnswers);
                if (question.shuffledAnswers) {
                    const correctAnswerObj = question.shuffledAnswers.find(obj => obj.originalLabel === question.correctAnswer);
                    console.log('Correct answer object:', correctAnswerObj);
                    console.log('Expected correct label after shuffle:', correctAnswerObj ? correctAnswerObj.label : 'NOT FOUND');
                }
                console.log('=== END DEBUG ===');
            }
            
            if (isCorrect) {
                quizStats.correct++;
            } else {
                quizStats.incorrect++;
            }
            quizStats.answered++;
            
            updateQuizStats();
            // KHÔNG gọi loadCurrentQuestion() ở đây nữa
            // Hiện feedback và nút 'Câu tiếp theo'
            const nextBtnElement = document.getElementById('nextBtn');
            if (nextBtnElement) nextBtnElement.style.display = 'inline-block';
            const showAnswerBtnElement = document.getElementById('showAnswerBtn');
            if (showAnswerBtnElement) showAnswerBtnElement.style.display = 'none';
            // Cập nhật lại giao diện feedback cho đáp án vừa chọn
            loadCurrentQuestion(false); // truyền false để không shuffle lại đáp án
        }
        
        function showAnswer() {
            if (userAnswers[currentQuestionIndex] !== undefined) return;
            
            const question = quizQuestions[currentQuestionIndex];
            if (question.correctAnswer) {
                userAnswers[currentQuestionIndex] = question.correctAnswer;
                quizStats.viewed++;  // Thay đổi từ incorrect sang viewed
                quizStats.answered++;
                
                updateQuizStats();
                loadCurrentQuestion(); // Reload without shuffling
            } else {
                showNotification('Không thể xác định đáp án đúng cho câu hỏi này', 'error');
            }
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < quizQuestions.length - 1) {
                currentQuestionIndex++;
                loadCurrentQuestion();
            }
        }
        
        function resetQuiz() {
            currentQuestionIndex = 0;
            userAnswers = {};
            quizStats = {
                answered: 0,
                correct: 0,
                incorrect: 0,
                viewed: 0
            };
            
            updateQuizStats();
            loadCurrentQuestion();
        }
        
        function showQuizResults() {
            const questionDiv = document.getElementById('currentQuestion');
            const accuracy = quizStats.answered > 0 ? Math.round((quizStats.correct / quizStats.answered) * 100) : 0;
            
            questionDiv.innerHTML = `
                <div class="question-card">
                    <h3>🎉 Kết quả Quiz</h3>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #2196f3; margin-bottom: 10px;">
                            ${accuracy}%
                        </div>
                        <div style="margin-bottom: 20px;">
                            <div>Đã trả lời: <strong>${quizStats.answered}</strong> / ${quizQuestions.length}</div>
                            <div>Đúng: <strong style="color: #4caf50;">${quizStats.correct}</strong></div>
                            <div>Sai: <strong style="color: #f44336;">${quizStats.incorrect}</strong></div>
                            <div>Xem đáp án: <strong style="color: #ff9800;">${quizStats.viewed}</strong></div>
                        </div>
                        <button class="quiz-btn" onclick="resetQuiz()">🔄 Làm lại</button>
                        <button class="quiz-btn" onclick="exitQuiz()">🏠 Thoát Quiz</button>
                    </div>
                </div>
            `;
            
            const nextBtnElement = document.getElementById('nextBtn');
            const showAnswerBtnElement = document.getElementById('showAnswerBtn');
            const resetBtnElement = document.getElementById('resetBtn');
            
            if (nextBtnElement) nextBtnElement.style.display = 'none';
            if (showAnswerBtnElement) showAnswerBtnElement.style.display = 'none';
            if (resetBtnElement) resetBtnElement.style.display = 'none';
        }
        
        function exitQuiz() {
            const currentQuestionElement = document.getElementById('currentQuestion');
            if (currentQuestionElement) {
                currentQuestionElement.style.display = 'none';
            }
            
            // Reset quiz state
            currentQuestionIndex = 0;
            userAnswers = {};
            quizStats = {
                answered: 0,
                correct: 0,
                incorrect: 0,
                viewed: 0
            };
            
            // Hide quiz elements
            const quizStatsElement = document.getElementById('quizStats');
            const nextBtnElement = document.getElementById('nextBtn');
            const showAnswerBtnElement = document.getElementById('showAnswerBtn');
            const resetBtnElement = document.getElementById('resetBtn');
            
            if (quizStatsElement) quizStatsElement.style.display = 'none';
            if (nextBtnElement) nextBtnElement.style.display = 'none';
            if (showAnswerBtnElement) showAnswerBtnElement.style.display = 'none';
            if (resetBtnElement) resetBtnElement.style.display = 'none';
        }
        
        function updateQuizStats() {
            const answeredElement = document.getElementById('answeredCount');
            const totalElement = document.getElementById('totalCount');
            const correctElement = document.getElementById('correctCount');
            const incorrectElement = document.getElementById('incorrectCount');
            const viewedElement = document.getElementById('viewedCount');
            
            if (answeredElement) answeredElement.textContent = quizStats.answered;
            if (totalElement) totalElement.textContent = quizQuestions.length;
            if (correctElement) correctElement.textContent = quizStats.correct;
            if (incorrectElement) incorrectElement.textContent = quizStats.incorrect;
            if (viewedElement) viewedElement.textContent = quizStats.viewed;
        }
        
        function showNotification(message, type = 'info') {
            // Create a better notification system
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}</span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // Add styles if not already added
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 1000;
                        max-width: 400px;
                        animation: slideIn 0.3s ease;
                    }
                    .notification-content {
                        display: flex;
                        align-items: center;
                        padding: 12px 16px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        font-size: 14px;
                    }
                    .notification-error .notification-content {
                        background: #fee;
                        color: #c53030;
                        border: 1px solid #feb2b2;
                    }
                    .notification-warning .notification-content {
                        background: #fffbeb;
                        color: #c05621;
                        border: 1px solid #fbd38d;
                    }
                    .notification-info .notification-content {
                        background: #ebf8ff;
                        color: #2b6cb0;
                        border: 1px solid #bee3f8;
                    }
                    .notification-icon {
                        margin-right: 8px;
                        font-size: 16px;
                    }
                    .notification-close {
                        background: none;
                        border: none;
                        font-size: 18px;
                        cursor: pointer;
                        margin-left: auto;
                        opacity: 0.7;
                    }
                    .notification-close:hover {
                        opacity: 1;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to selected tab button
            const selectedButton = event.target;
            selectedButton.classList.add('active');
            
            // If switching to quiz tab, check if there are difficult questions
            if (tabName === 'quiz') {
                const questions = getDifficultQuestions();
                if (questions.length === 0) {
                    showNotification('Không có câu hỏi khó nào để làm quiz!', 'warning');
                }
            }
        }



         function randomizeQuestions() {
             const questions = getDifficultQuestions();
             
             if (questions.length === 0) {
                 showNotification('Không có câu hỏi nào để sắp xếp ngẫu nhiên', 'warning');
                 return;
             }
             
             // Fisher-Yates shuffle algorithm for random sorting
             const shuffledQuestions = [...questions];
             for (let i = shuffledQuestions.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [shuffledQuestions[i], shuffledQuestions[j]] = [shuffledQuestions[j], shuffledQuestions[i]];
             }
             
             // Update localStorage with shuffled questions
             localStorage.setItem('difficultQuestions', JSON.stringify(shuffledQuestions));
             loadDifficultQuestions(); // Re-render the list with shuffled data
             
             showNotification('Đã sắp xếp câu hỏi ngẫu nhiên', 'info');
         }

         function filterDifficultQuestions() {
             const filterSelect = document.getElementById('filterSelect');
             const filterValue = filterSelect.value;
             
             // Store filter preference
             localStorage.setItem('difficultQuestionsFilter', filterValue);
             
             // Reload questions with filter
             loadDifficultQuestions();
             
             // Show notification about filter change
             if (filterValue === 'all') {
                 showNotification('Đã hiển thị tất cả câu hỏi khó', 'info');
             } else {
                 // Get the display name for the range
                 const rangeDisplayName = getRangeDisplayName(filterValue);
                 showNotification(`Đã lọc theo: ${rangeDisplayName}`, 'info');
             }
         }
        
        // Load questions when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Page loaded, initializing...');
            
            // Load quiz data first
            const quizDataLoaded = await loadQuizData();
            
            // Restore filter preference
            const savedFilter = localStorage.getItem('difficultQuestionsFilter');
            
            if (savedFilter) {
                const filterSelect = document.getElementById('filterSelect');
                if (filterSelect) filterSelect.value = savedFilter;
            }
            
            // Load difficult questions
            loadDifficultQuestions();
            
            // Debug: Log ra dữ liệu để kiểm tra
            const questions = getDifficultQuestions();
            console.log('Difficult questions data:', questions);
            
            // Always show tabs, quiz mode is now in its own tab
            console.log('Tabs initialized');
        });
    </script>
</body>
</html> 